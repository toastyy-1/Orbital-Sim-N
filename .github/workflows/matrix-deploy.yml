name: Matrix Nightly Native Builds

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - os: windows-latest
            artifact: windows-x64-msvc
          - os: macos-14
            artifact: macos-intel
          - os: macos-14-arm64
            artifact: macos-arm64
          - os: ubuntu-latest
            artifact: ubuntu-generic
          - os: ubuntu-latest
            artifact: ubuntu-deb
            package: DEB
          - os: ubuntu-latest
            artifact: ubuntu-rpm
            package: RPM
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Conan
      uses: conan-io/setup-conan@v1

    - name: Install packaging deps
      if: matrix.config.package
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm fakeroot devscripts rpm2cpio

    - name: Build project (Windows)
      if: matrix.config.os == 'windows-latest'
      shell: cmd
      run: |
        mkdir build
        cd build
        conan profile detect --force
        conan install .. --build=missing -s build_type=Release -c tools.system.package_manager:mode=install -c tools.system.package_manager:sudo=True
        cmake .. -DCMAKE_TOOLCHAIN_FILE=generators\conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release --parallel

    - name: Build project (Unix/macOS)
      if: matrix.config.os != 'windows-latest'
      shell: bash
      run: |
        mkdir -p build
        cd build
        conan profile detect --force
        conan install .. --build=missing -s build_type=Release -c tools.system.package_manager:mode=install -c tools.system.package_manager:sudo=True
        cmake .. -DCMAKE_TOOLCHAIN_FILE=generators/conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release --parallel

    - name: Package
      if: matrix.config.package
      run: |
        cd build
        cpack -G ${{ matrix.config.package }} -C Release

    - name: Zip artifacts (Windows)
      if: matrix.config.os == 'windows-latest'
      shell: powershell
      run: |
        cd build/Release
        $binary = Get-ChildItem -Name "OrbitSimulation*" -Include *.exe | Select-Object -First 1
        cp ../../data/simulation_data.json .
        Compress-Archive -Path $binary, ../../shaders, ../../assets, simulation_data.json, SDL3*.dll -DestinationPath "../OrbitSimulation-${{ matrix.config.artifact }}.zip" -Force
        cp simulation_data.json ../../simulation_data.json

    - name: Zip artifacts (Unix/macOS)
      if: matrix.config.os != 'windows-latest' && !matrix.config.package
      shell: bash
      run: |
        cd build
        BINARY=$(find . -name "OrbitSimulation" -type f -executable | head -1)
        cp ../data/simulation_data.json .
        cp -r ../shaders .
        cp -r ../assets .
        tar -czf OrbitSimulation-${{ matrix.config.artifact }}.tar.gz "$BINARY" simulation_data.json shaders assets
        cp simulation_data.json ../

    - name: Copy package artifacts
      if: matrix.config.package
      run: |
        cd build
        cp OrbitSimulation*.deb ../OrbitSimulation-${{ matrix.config.artifact }}.deb 2>/dev/null || true
        cp OrbitSimulation*.rpm ../OrbitSimulation-${{ matrix.config.artifact }}.rpm 2>/dev/null || true
        cp OrbitSimulation*.tar.gz ../ 2>/dev/null || true
        cp ../data/simulation_data.json ../simulation_data.json

    - name: Upload temp artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.config.artifact }}
        path: |
          build/OrbitSimulation-${{ matrix.config.artifact }}.*
          OrbitSimulation-${{ matrix.config.artifact }}.*
          simulation_data.json

  nightly-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4

    - name: Update Nightly Release
      uses: andelf/nightly-release@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: nightly
        name: Nightly ${{ github.run_number }} (${{ github.sha }})
        prerelease: true
        files: |
          windows-x64-msvc/OrbitSimulation-windows-*.zip
          macos-intel/OrbitSimulation-macos-*.tar.gz
          macos-arm64/OrbitSimulation-macos-*.tar.gz
          ubuntu-generic/OrbitSimulation-ubuntu-*.tar.gz
          ubuntu-deb/*.deb
          ubuntu-rpm/*.rpm
          */simulation_data.json
